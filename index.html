<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#16a34a" id="themeColor">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Redirect">
	<meta name="mobile-web-app-capable" content="yes">
    <title>Открываем ссылку…</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Montserrat font + общие стили проекта -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://speedtest.incdev.net/styles/variables.css?100">
    <link rel="stylesheet" href="https://speedtest.incdev.net/styles/base.css?100">
    <link rel="stylesheet" href="https://speedtest.incdev.net/styles/components.css?100">
    <link rel="stylesheet" href="https://speedtest.incdev.net/styles/responsive.css?100">
    <style>
        /* Узкие экраны (iPhone SE и подобные) */
        @media (max-width: 360px) {
            .platform-card { padding: 16px !important; }
            .card-content { padding: 14px !important; }
            .steps-hint { padding: 8px 10px !important; }
            .steps-inline { gap: 6px !important; font-size: 13px; }
            .step-badge { width: 20px; height: 20px; font-size: 11px; }
            .btn { padding: 10px 12px; font-size: 13px; }
        }
        /* Безопасные области (верх/низ) и динамическая высота */
        .redirect-shell { min-height: 100dvh; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
        .steps-inline { flex-wrap: wrap; max-width: 100%; }
        .step-inline-item { max-width: 100%; }
    </style>
</head>
<body>
    <!-- Лоадер в стиле основного приложения -->
    <div id="appLoader" class="loading-overlay" role="status" aria-live="polite" aria-busy="true">
        <div class="loader-spinner" aria-hidden="true"></div>
    </div>
    <div class="container redirect-shell" style="display:flex;align-items:center;justify-content:center;">
        <main id="mainContent" style="width:100%;max-width:680px;">
            <section class="platform-screen" style="max-width:680px;width:100%;padding-left: 10px;padding-right: 10px;">
                <div class="platform-card card" style="animation: fadeIn .25s ease-out;">
                    <div class="card-content" style="text-align:center;">
                        <div class="steps-hint" role="note" aria-label="Redirect info" style="margin-bottom:0;">
                            <div class="steps-inline" style="gap:10px;">
                                <div class="step-inline-item"><span class="step-badge">1</span><span>Открываем ссылку…</span></div>
                                <div class="step-inline-item"><span class="step-badge">2</span><span>Если не открылось — нажмите кнопку</span></div>
                            </div>
                        </div>
                        <div style="margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                            <button id="openBtn" class="btn btn-primary"><span>Открыть ссылку</span></button>
                            <button id="supportBtn" class="btn"><span>Поддержка</span></button>
                        </div>
                        <div class="loading-indicator" style="margin-top:12px;display:flex;align-items:center;justify-content:center;gap:6px;color:var(--text-muted);font-size:14px;">
                            <div class="spinner" style="width:14px;height:14px;border:2px solid var(--border);border-top:2px solid var(--primary-color);border-radius:50%;animation: spin .9s linear infinite;"></div>
                            <span>Автоматическое перенаправление через <span id="countdown" style="color:var(--primary-color);font-weight:800;">5</span> сек…</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
    (function() {
        // Тема: auto по системной настройке для совместимости между доменами
        applyAutoTheme();
        setupTelegram();

        const finalUrl = resolveRedirectUrl();

        const open = () => safeOpen(finalUrl);
        document.getElementById('openBtn').addEventListener('click', open);
        document.getElementById('supportBtn').addEventListener('click', () => {
            const url = 'https://t.me/incvpn_support';
            try {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.openLink(url, { try_instant_view: false });
                    return;
                }
            } catch {}
            try {
                const w = window.open(url, '_blank', 'noopener,noreferrer');
                if (w) return;
            } catch {}
            try { location.href = url; } catch {}
        });

        // Показываем страницу сразу, без перекрытия лоадером
        requestAnimationFrame(hideLoader);

        // 5-секундный таймер редиректа с обновлением текста
        if (finalUrl) {
            let countdown = 5;
            const countdownEl = document.getElementById('countdown');
            const update = () => {
                if (countdownEl) countdownEl.textContent = String(countdown);
            };
            update();
            const timer = setInterval(() => {
                countdown -= 1;
                update();
                if (countdown <= 0) {
                    clearInterval(timer);
                    open();
                }
            }, 1000);
        } else {
            const li = document.querySelector('.loading-indicator');
            if (li) li.style.display = 'none';
        }

        function applyAutoTheme() {
            const html = document.documentElement;
            const meta = document.getElementById('themeColor');
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            html.classList.toggle('dark-theme', isDark);
            try { meta.setAttribute('content', isDark ? '#0f172a' : '#16a34a'); } catch {}
        }

        function setupTelegram() {
            try {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    Telegram.WebApp.onEvent('viewportChanged', () => {
                        try { Telegram.WebApp.expand(); } catch {}
                    });
                    try { Telegram.WebApp.setHeaderColor('secondary'); } catch {}
                    try {
                        const isDark = document.documentElement.classList.contains('dark-theme');
                        Telegram.WebApp.setBackgroundColor(isDark ? '#0f172a' : '#ffffff');
                    } catch {}
                }
            } catch {}
        }

		function resolveRedirectUrl() {
			try {
				// 1) Пытаемся достать из query
				const searchParams = new URLSearchParams(location.search);
				let raw = searchParams.get('redirect_to') || '';
				// 2) Если пусто — проверяем hash (поддержка #redirect_to=... и #...&redirect_to=...)
				if (!raw && location.hash) {
					const hash = location.hash.replace(/^#/, '');
					const hashParams = new URLSearchParams(hash.includes('?') ? hash.split('?')[1] : hash);
					raw = hashParams.get('redirect_to') || '';
				}
				// 3) Последний фолбэк — регэксп по всей строке URL
				if (!raw) {
					const m = /[?#&]redirect_to=([^&#]+)/.exec(location.href);
					raw = (m && m[1]) ? m[1] : '';
				}

				if (!raw) return '';

				// Декодирование только URL-encoding; '+' в query трактуем как пробел
				try { raw = decodeURIComponent(raw.replace(/\+/g, '%20')); } catch {}

				// Блокируем только опасные схемы; кастомные (например, happ:) допускаем
				const blockedSchemes = ['javascript:', 'data:'];
				const a = document.createElement('a');
				a.href = raw;
				if (blockedSchemes.includes(a.protocol)) return '';
				// Для кастомных схем возвращаем исходную строку, чтобы не полагаться на нормализацию браузера
				if (!a.protocol || (a.protocol && a.protocol.endsWith(':') && !/^https?:|^mailto:|^tel:/.test(a.protocol))) {
					return raw;
				}
				return a.href;
			} catch {
				return '';
			}
		}

        function safeOpen(url) {
            if (!url) return;
            // Сначала пробуем Telegram API (лучший вариант внутри WebApp)
            try {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.openLink(url, { try_instant_view: false });
                    return;
                }
            } catch {}
            // Фолбэк: window.open, затем прямой переход
            try {
                const w = window.open(url, '_blank', 'noopener,noreferrer');
                if (w) return;
            } catch {}
            try { location.href = url; } catch {}
        }

        function hideLoader() {
            const el = document.getElementById('appLoader');
            if (el) {
                el.classList.add('hidden');
                el.setAttribute('aria-busy', 'false');
            }
        }
    })();
    </script>
</body>
</html>


